<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Donor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Base Styles */
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: row;
      }

      .sidebar {
        width: 250px;
        background-color: #74a57f;
        transition: all 0.3s ease;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
      }

      main {
        margin-left: 250px;
        width: calc(100% - 250px);
        min-height: 100vh;
      }

      .bg-opacity {
        background-color: rgba(38, 63, 43, 0.6);
      }

      .notification-bell {
        position: absolute;
        right: 70px;
        cursor: pointer;
        font-size: 24px;
      }

      .notification-dropdown {
        display: none;
        position: fixed;
        right: 20px;
        top: 60px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 10px;
        width: 300px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
      }

      .notification-item {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
      }

      .notification-item:hover {
        background: #e0c1a3;
      }

      .notification-item.unread {
        background: #f6e6d8;
      }

      .replies-section {
        margin-top: 20px;
        padding: 10px;
        background: #f6e6d8;
        border-radius: 8px;
      }

      .reply-item {
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border-radius: 5px;
      }

      .reply-item.agent {
        background: #e0c1a3;
      }

      .header {
        background: #74a57f;
        padding: 20px;
        text-align: center;
        font-size: 1.5rem;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        font-weight: 700;
        letter-spacing: 0.1em;
      }

      .sidebar-spacing {
        margin: 20px 0;
      }

      .home-button {
        width: 100%;
        padding: 10px;
        background: #127536;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-bottom: 15px;
      }

      .home-button:hover {
        background: #5d8a67;
      }

      /* Mobile Menu Button */
      .mobile-menu-btn {
        display: none;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: #74a57f;
        border: none;
        color: white;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
      }

      /* Responsive Styles */
      @media (max-width: 1024px) {
        .sidebar {
          width: 200px;
        }

        main {
          margin-left: 200px;
          width: calc(100% - 200px);
        }

        .notification-dropdown {
          width: 250px;
        }

        #food-form {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        #food-form button {
          width: 100%;
        }
      }

      @media (max-width: 768px) {
        body {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          position: fixed;
          left: -100%;
          top: 0;
          height: 100vh;
          z-index: 999;
          transition: left 0.3s ease;
        }

        .sidebar.active {
          left: 0;
        }

        .mobile-menu-btn {
          display: block;
        }

        main {
          margin-left: 0;
          width: 100%;
        }

        .header {
          padding: 15px;
          font-size: 1.2rem;
        }

        .notification-bell {
          right: 20px;
        }

        .notification-dropdown {
          width: 90%;
          max-width: 300px;
          right: 10px;
        }

        #food-form {
          grid-template-columns: 1fr;
          gap: 8px;
        }

        #food-form input,
        #food-form select {
          width: 100%;
          box-sizing: border-box;
        }

        #food-form button {
          width: 100%;
          padding: 8px;
        }

        /* Success Popup Responsive */
        #success-popup div {
          width: 90%;
          max-width: 400px;
          padding: 20px;
        }

        #success-popup h2 {
          font-size: 1.5rem;
        }

        #success-popup p {
          font-size: 1rem;
        }

        /* Reviews Modal Responsive */
        #reviews-modal div {
          width: 95%;
          max-width: 95%;
          padding: 15px;
          margin: 10px;
        }

        #reviews-modal h2 {
          font-size: 1.5rem;
        }

        .reviews-container {
          max-height: 60vh;
          overflow-y: auto;
        }

        /* Complaint Modal Responsive */
        #complaint-modal div {
          width: 90%;
          max-width: 90%;
          padding: 15px;
        }

        #complaint-modal textarea {
          width: 100%;
          box-sizing: border-box;
        }
      }

      @media (max-width: 480px) {
        .header {
          padding: 10px;
          font-size: 1rem;
        }

        .notification-bell {
          font-size: 20px;
          right: 15px;
        }

        .notification-dropdown {
          width: 95%;
          right: 5px;
          max-height: calc(100vh - 60px);
        }

        #raiseComplaintBtn {
          padding: 5px 10px;
          font-size: 0.875rem;
        }

        .bg-white {
          padding: 15px;
        }

        h2 {
          font-size: 1.1rem;
        }

        p {
          font-size: 0.9rem;
        }

        /* Success Popup Mobile */
        #success-popup div {
          width: 95%;
          padding: 15px;
        }

        #success-popup .text-7xl {
          font-size: 4rem;
        }

        #success-popup h2 {
          font-size: 1.2rem;
        }

        #success-popup p {
          font-size: 0.9rem;
        }

        /* Reviews Modal Mobile */
        #reviews-modal div {
          width: 95%;
          padding: 10px;
          margin: 5px;
        }

        #reviews-modal h2 {
          font-size: 1.2rem;
        }

        .reviews-container {
          max-height: 70vh;
        }

        /* Complaint Modal Mobile */
        #complaint-modal div {
          width: 95%;
          padding: 10px;
        }

        #complaint-modal h2 {
          font-size: 1.2rem;
        }
      }

      /* Add smooth transitions */
      .notification-dropdown,
      #success-popup,
      #reviews-modal,
      #complaint-modal {
        transition: all 0.3s ease;
      }

      /* Ensure proper z-index layering */
      .sidebar {
        z-index: 1000;
      }

      .mobile-menu-btn {
        z-index: 1001;
      }

      .notification-dropdown {
        z-index: 1002;
      }

      #success-popup,
      #reviews-modal,
      #complaint-modal {
        z-index: 1003;
      }
    </style>
  </head>
  <body class="flex bg-opacity text-white">
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <!-- Sidebar -->
    <aside class="sidebar text-white p-5 min-h-screen">
      <h2 class="text-3xl font-bold">Aahar Link</h2>
      <div class="sidebar-spacing"></div>
      <nav>
        <ul>
          <li class="py-2">
            <button
              onclick="window.location.href='home.html'"
              class="home-button"
            >
              üè† Home
            </button>
          </li>
          <li class="py-2">
            <a href="#" class="block" id="reviews-link">‚≠ê Reviews</a>
          </li>
          <!-- Logout Button -->
          <li class="py-96 mt-4"></li>
          <div class="mt-auto flex justify-center pb-4">
            <button
              id="logout-btn"
              class="bg-red-500 text-white px-4 py-2 rounded w-32"
            >
              Logout
            </button>
          </div>
        </ul>
      </nav>
    </aside>

    <script>
      function toggleSidebar() {
        const sidebar = document.querySelector(".sidebar");
        sidebar.classList.toggle("active");
      }

      /*document
        .getElementById("logout-btn")
        .addEventListener("click", function () {
          if (confirm("Are you sure you want to log out?")) {
            console.log("User logged out.");
            alert("You have been logged out.");
            window.location.href = "/donor_login.html";
          }
        });*/
    </script>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <header class="flex justify-between items-center mb-5 bg-[#74A57F] p-4">
        <h1
          class="text-2xl font-bold text-white text-center flex-1 tracking-wider"
        >
          DONOR DASHBOARD
        </h1>
        <div class="flex items-center gap-4">
          <div
            class="relative text-red-500 text-xl cursor-pointer"
            id="notification-btn"
          >
            üîî
            <span
              id="notification-count"
              class="absolute -top-2 -right-2 bg-red-500 text-white text-xs px-1 rounded-full"
            >
              0
            </span>
            <!-- Notifications Dropdown -->
            <div
              id="notification-dropdown"
              class="hidden fixed right-0 mt-3 w-80 bg-white border border-gray-300 rounded-lg shadow-lg z-50 p-4 space-y-2 text-sm"
            >
              <p class="text-gray-500">Loading...</p>
            </div>
          </div>
          <button
            id="raiseComplaintBtn"
            class="bg-green-700 text-white text-sm px-3 py-1 rounded hover:bg-yellow-600 transition"
          >
            üìù Raise Complaint
          </button>
        </div>
      </header>

      <!-- Donor Details Section -->
      <div class="bg-white p-4 rounded-lg shadow-md mt-5 text-black">
        <h2 class="text-xl font-bold mb-3">Donor Details</h2>
        <p>
          <strong>FBO/Company Name:</strong>
          <span id="companyname">Loading...</span>
        </p>
        <p>
          <strong>Premises Address:</strong>
          <span id="address">Verify First</span>
        </p>
        <p>
          <strong></strong>
          <span id="phone"></span>
        </p>
        <!-- Verification Button -->
        <button
          id="verifyNow"
          class="w-full mt-3 bg-[#74A57F] text-white py-2 rounded"
        >
          Verify Now
        </button>
        <p id="verificationStatus" class="text-red-500 text-sm mt-2"></p>
      </div>

      <!-- Add New Food Listing Form -->
      <div class="bg-white p-4 rounded-lg shadow-md mt-5 text-black">
        <h2 class="text-xl font-bold mb-3">Add New Food Listing</h2>
        <div
          id="unverified-message"
          class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4"
        >
          <p class="font-bold">Verification Required</p>
          <p>
            Please verify your account to add food listings. Click the "Verify
            Now" button above to proceed.
          </p>
        </div>
        <form id="food-form" class="grid grid-cols-2 gap-4">
          <input
            type="text"
            id="food-title"
            placeholder="Food Title"
            class="p-2 border rounded"
            disabled
          />
          <select id="food-type" class="p-2 border rounded" disabled>
            <option value="veg">Veg</option>
            <option value="nonveg">Non-Veg</option>
          </select>
          <input
            type="text"
            id="food-quantity"
            placeholder="Quantity (e.g., 2 kg)"
            class="p-2 border rounded"
            disabled
          />
          <input
            type="date"
            id="food-expiry"
            class="p-2 border rounded"
            disabled
          />
          <select id="food-status" class="p-2 border rounded" disabled>
            <option value="Active">Active</option>
            <option value="Expired">Expired</option>
          </select>
          <button
            type="submit"
            class="col-span-2 bg-[#74A57F] text-white px-4 py-2 rounded opacity-50 cursor-not-allowed"
            disabled
          >
            Add Listing
          </button>
        </form>
      </div>

      <!-- Available Food Listings -->
      <div class="bg-white p-4 rounded-lg shadow-md mt-5 text-black">
        <h2 class="text-xl font-bold mb-3">Available Food Listings</h2>
        <div class="overflow-x-auto">
          <table
            id="food-listings"
            class="w-full text-left border-collapse min-w-[800px]"
          >
            <thead>
              <tr>
                <th class="border-b p-2 w-1/6">Title</th>
                <th class="border-b p-2 w-1/6">Type</th>
                <th class="border-b p-2 w-1/6">Quantity</th>
                <th class="border-b p-2 w-1/6">Expiry Date</th>
                <th class="border-b p-2 w-1/6">Status</th>
                <th class="border-b p-2 w-1/6">Requested By</th>
                <th class="border-b p-2 w-1/6">Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Listings will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
    <!-- FSSAI License Modal -->
    <div
      id="fssai-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white text-black p-6 rounded shadow-md w-80">
        <h3 class="text-lg font-bold mb-3">Enter FSSAI License No.</h3>
        <input
          type="text"
          id="fssai-license-input"
          placeholder="License / Registration No."
          class="w-full p-2 border rounded mb-4"
        />
        <div class="flex justify-end gap-2">
          <button
            id="cancel-modal"
            class="bg-gray-300 px-3 py-1 rounded hover:bg-gray-400"
          >
            Cancel
          </button>
          <button
            id="submit-license"
            class="bg-[#74A57F] text-white px-3 py-1 rounded hover:bg-green-600"
          >
            Submit
          </button>
        </div>
      </div>
    </div>

    <!-- Success Popup Modal -->
    <div
      id="success-popup"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"
    >
      <div
        class="bg-white rounded-lg p-8 w-full max-w-md shadow-xl text-center transform transition-all"
      >
        <div class="text-7xl mb-6 animate-bounce">üéâ</div>
        <h2 class="text-3xl font-bold mb-2 text-[#74A57F]">
          Donation Confirmed!
        </h2>
        <p class="text-xl mb-8 text-gray-700">
          Great Job! Your Kindness helped to resolve hunger.
        </p>
        <button
          onclick="closeSuccessPopup()"
          class="bg-[#74A57F] text-white px-8 py-3 rounded-lg hover:bg-[#5d8a67] transition-colors duration-300 font-semibold"
        >
          Close
        </button>
      </div>
    </div>

    <!-- Reviews Modal -->
    <div
      id="reviews-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"
    >
      <div
        class="bg-white text-black rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto shadow-[0_4px_6px_#d5f7d5]"
      >
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-2xl font-bold">Receiver Reviews</h2>
            <div id="average-rating" class="text-gray-600 mt-1">
              Average Rating: <span class="font-bold">0</span>/5
            </div>
          </div>
          <button
            onclick="closeReviewsModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <div id="reviews-container" class="space-y-6">
          <!-- Reviews will be loaded here -->
        </div>

        <div id="no-reviews" class="hidden text-center py-8 text-gray-500">
          No reviews yet
        </div>
      </div>
    </div>

    <script>
      // Initialize total food saved (if needed)
      let totalFoodSaved = 0;

      // Function to fetch and display donation requests
      async function fetchDonationRequests() {
        try {
          const response = await fetch("/api/donations/requests", {
            credentials: "include",
          });
          const requests = await response.json();

          const requestsList = document.getElementById("requests-list");
          if (!requestsList) {
            console.log("Requests list element not found, skipping update");
            return;
          }

          requestsList.innerHTML = "";

          requests.forEach((request) => {
            const requestElement = document.createElement("div");
            requestElement.className = "border-b p-4";
            requestElement.innerHTML = `
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-bold">${request.title}</p>
                  <p class="text-sm text-gray-600">Requested by: ${
                    request.receiverId.nponame
                  }</p>
                  <p class="text-sm text-gray-600">Status: ${request.status}</p>
                </div>
                <div class="mt-2">
                  ${
                    request.status === "Claimed"
                      ? `
                    <button class="bg-green-500 text-white px-4 py-2 rounded donate-btn" 
                      data-id="${request._id}" 
                      data-receiver="${request.receiverId._id}">
                      Donate
                    </button>
                  `
                      : ""
                  }
                </div>
              </div>
            `;
            requestsList.appendChild(requestElement);
          });

          // Add event listeners to donate buttons
          document.querySelectorAll(".donate-btn").forEach((btn) => {
            btn.addEventListener("click", async function () {
              const donationId = this.dataset.id;
              const receiverId = this.dataset.receiver;

              try {
                const response = await fetch(
                  `/api/donations/donate/${donationId}`,
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      receiverId: receiverId,
                      status: "Confirmed",
                    }),
                  }
                );

                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(
                    errorData.message || "Failed to approve donation"
                  );
                }

                const data = await response.json();
                if (data.success) {
                  showSuccessPopup();
                  // Refresh both the listings and requests
                  await Promise.all([
                    loadExistingDonations(),
                    fetchDonationRequests(),
                  ]);
                } else {
                  throw new Error(data.message || "Failed to confirm donation");
                }
              } catch (error) {
                console.error("Error confirming donation:", error);
                alert(
                  error.message ||
                    "Failed to confirm donation. Please try again."
                );
              }
            });
          });
        } catch (error) {
          console.error("Error fetching requests:", error);
        }
      }

      // Handle Add Listing form submission
      document
        .getElementById("food-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          // Check verification status before allowing submission
          try {
            const verificationResponse = await fetch(
              `${baseUrl}/api/donor/status`
            );
            const verificationData = await verificationResponse.json();

            if (!verificationData.verified) {
              alert("Please verify your account before adding food listings.");
              return;
            }

            // Get input values
            const title = document.getElementById("food-title").value.trim();
            const type = document.getElementById("food-type").value;
            const quantity = document
              .getElementById("food-quantity")
              .value.trim();
            const expiry = document.getElementById("food-expiry").value;
            const status = document.getElementById("food-status").value;

            if (!title || !quantity || !expiry) {
              alert("Please fill in all fields!");
              return;
            }

            const response = await fetch(`${baseUrl}/api/donor/donations`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
              body: JSON.stringify({
                title,
                type,
                quantity,
                expiryDate: expiry,
                status,
              }),
            });

            const data = await response.json();

            if (data.success) {
              addListingToTable(data.donation);
              document.getElementById("food-form").reset();
            } else {
              alert(data.message || "Failed to add donation");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Failed to add donation. Please try again.");
          }
        });

      function addListingToTable(donation) {
        const tableBody = document.querySelector("#food-listings tbody");
        const foodSymbol =
          donation.type === "veg"
            ? '<span class="text-green-500 text-lg">‚óè</span> Veg'
            : '<span class="text-red-500 text-lg">‚óè</span> Non-Veg';

        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="p-2">${donation.title}</td>
          <td class="p-2 flex items-center gap-2">${foodSymbol}</td>
          <td class="p-2">${donation.quantity}</td>
          <td class="p-2">${new Date(
            donation.expiryDate
          ).toLocaleDateString()}</td>
          <td class="p-2 ${
            donation.status === "Active"
              ? "text-green-500"
              : donation.status === "Expired"
              ? "text-red-500"
              : donation.status === "Claimed"
              ? "text-yellow-500"
              : donation.status === "Confirmed"
              ? "text-green-500"
              : "text-gray-500"
          }">${donation.status}</td>
          <td class="p-2">${donation.receiverId?.nponame || "-"}</td>
          <td class="p-2">
            ${
              donation.status === "Claimed"
                ? `
              <div class="flex gap-2">
                <button class="bg-green-500 text-white px-2 py-1 rounded donate-btn" 
                  data-id="${donation._id}"
                  data-receiver="${donation.receiverId?._id}">
                  Donate
                </button>
              </div>
            `
                : ""
            }
          </td>
        `;
        tableBody.appendChild(row);

        // Add event listener to donate button if it exists
        const donateBtn = row.querySelector(".donate-btn");
        if (donateBtn) {
          donateBtn.addEventListener("click", async function () {
            const donationId = this.dataset.id;
            const receiverId = this.dataset.receiver;

            try {
              // Check verification status before allowing donation
              const verificationResponse = await fetch(
                `${baseUrl}/api/donor/status`
              );
              const verificationData = await verificationResponse.json();

              if (!verificationData.verified) {
                alert("Please verify your account before making donations.");
                return;
              }

              const response = await fetch(
                `/api/donations/donate/${donationId}`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    receiverId: receiverId,
                    status: "Confirmed",
                  }),
                }
              );

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(
                  errorData.message || "Failed to confirm donation"
                );
              }

              const data = await response.json();
              if (data.success) {
                showSuccessPopup();
                // Refresh both the listings and requests
                await Promise.all([
                  loadExistingDonations(),
                  fetchDonationRequests(),
                ]);
              } else {
                throw new Error(data.message || "Failed to confirm donation");
              }
            } catch (error) {
              console.error("Error confirming donation:", error);
              alert(
                error.message || "Failed to confirm donation. Please try again."
              );
            }
          });
        }
      }

      // Add this function to load existing donations when the page loads
      async function loadExistingDonations() {
        try {
          const response = await fetch(`${baseUrl}/api/donor/donations`, {
            credentials: "include",
          });
          const data = await response.json();

          if (data.success) {
            const tableBody = document.querySelector("#food-listings tbody");
            tableBody.innerHTML = ""; // Clear existing entries

            // Filter out collected donations
            const activeDonations = data.donations.filter(
              (donation) => donation.status !== "Collected"
            );

            activeDonations.forEach((donation) => addListingToTable(donation));
          }
        } catch (error) {
          console.error("Error loading donations:", error);
        }
      }
      // Initialize the dashboard
      document.addEventListener("DOMContentLoaded", function () {
        loadExistingDonations();
      });
    </script>

    <script>
      // Define baseUrl at the top of the file
      const baseUrl = window.location.origin;
      let notifications = [];

      async function loadNotifications() {
        try {
          console.log("Loading notifications...");
          const res = await fetch(`${baseUrl}/api/complaints/notifications`, {
            credentials: "include", // Important: Include cookies for session
          });
          const data = await res.json();
          console.log("Notifications response:", data);

          if (data.success) {
            notifications = data.notifications;
            updateNotificationUI();
          } else {
            console.error("Failed to load notifications:", data.message);
          }
        } catch (error) {
          console.error("Error loading notifications:", error);
        }
      }

      function updateNotificationUI() {
        const dropdown = document.getElementById("notification-dropdown");
        const count = document.getElementById("notification-count");

        // Update notification count
        const unreadCount = notifications.filter((n) => !n.read).length;
        count.textContent = unreadCount;

        dropdown.innerHTML =
          notifications.length === 0
            ? "<p>No notifications</p>"
            : notifications
                .map(
                  (notification) => `
              <div class="notification-item ${
                notification.read ? "" : "unread"
              }" 
                   onclick="handleNotificationClick('${notification._id}', '${
                    notification.ticketId
                  }')">
                <p>${notification.message}</p>
                <small>${new Date(
                  notification.timestamp
                ).toLocaleString()}</small>
              </div>
            `
                )
                .join("");
      }

      async function handleNotificationClick(notificationId, ticketId) {
        try {
          // Mark notification as read
          await fetch(
            `${baseUrl}/api/complaints/notifications/${notificationId}/read`,
            {
              method: "PUT",
              credentials: "include", // Important: Include cookies for session
            }
          );

          // Show the ticket details
          const res = await fetch(`${baseUrl}/api/complaints/all`, {
            credentials: "include", // Important: Include cookies for session
          });
          const data = await res.json();

          if (data.success) {
            const ticket = data.complaints.find((t) => t.ticketId === ticketId);
            if (ticket) {
              showTicketDetails(ticket);
              loadNotifications(); // Refresh notifications
            }
          }
        } catch (error) {
          console.error("Error handling notification click:", error);
        }
      }

      function showTicketDetails(ticket) {
        // Create a modal to show ticket details
        const modal = document.createElement("div");
        modal.className =
          "modal-ticket-reply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4";
        modal.innerHTML = `
          <div class="bg-white text-black rounded-lg shadow-lg w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-6 flex-none border-b">
              <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Ticket #${ticket.ticketId}</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">‚úï</button>
              </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
              <p class="mb-2"><strong>Status:</strong> ${ticket.status}</p>
              <p class="mb-2"><strong>Title:</strong> ${ticket.title}</p>
              <p class="mb-4"><strong>Description:</strong> ${
                ticket.description
              }</p>
              <div class="replies-section">
                <h4 class="font-bold mb-2">Replies:</h4>
                ${ticket.replies
                  .map(
                    (reply) => `
                  <div class="reply-item ${
                    reply.sender === "agent" ? "agent" : ""
                  } mb-2">
                    <p><strong>${
                      reply.sender === "agent" ? "Customer Support" : "You"
                    }:</strong></p>
                    <p>${reply.message}</p>
                    <small>${new Date(reply.timestamp).toLocaleString()}</small>
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>
            ${
              ticket.status === "Open"
                ? `
              <div class="p-6 flex-none border-t">
                <h4 class="font-bold mb-2">Reply:</h4>
                <textarea id="reply-text" rows="4" class="w-full border rounded p-2 mb-2" placeholder="Type your reply here..."></textarea>
                <button onclick="submitReply('${ticket._id}')" class="bg-[#74A57F] text-white px-4 py-2 rounded">Submit Reply</button>
              </div>
            `
                : ""
            }
          </div>
        `;
        document.body.appendChild(modal);
      }

      async function submitReply(ticketId) {
        const replyText = document.getElementById("reply-text").value;
        if (!replyText) return;

        try {
          // First check if the complaint is still open
          const checkRes = await fetch(`${baseUrl}/api/complaints/all`, {
            credentials: "include",
          });
          const checkData = await checkRes.json();

          if (checkData.success) {
            const ticket = checkData.complaints.find((t) => t._id === ticketId);
            if (!ticket || ticket.status !== "Open") {
              alert("Cannot reply to a resolved complaint");
              return;
            }

            const res = await fetch(
              `${baseUrl}/api/complaints/update/${ticketId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  reply: replyText,
                  sender: "user", // Always send as user
                }),
              }
            );

            const data = await res.json();
            if (data.success) {
              alert("Reply submitted successfully");
              // Remove the modal
              const modal = document.querySelector(".modal-ticket-reply");
              if (modal) {
                modal.remove();
              }

              // Refresh notifications
              loadNotifications();
            } else {
              alert(
                "Failed to submit reply: " + (data.message || "Unknown error")
              );
            }
          }
        } catch (error) {
          console.error("Error submitting reply:", error);
          alert("Failed to submit reply. Please try again.");
        }
      }

      // Load notifications periodically
      setInterval(loadNotifications, 30000); // Every 30 seconds
      loadNotifications(); // Initial load

      // Add click handler for notification bell
      document
        .getElementById("notification-btn")
        .addEventListener("click", () => {
          const dropdown = document.getElementById("notification-dropdown");
          dropdown.classList.toggle("hidden");
          if (!dropdown.classList.contains("hidden")) {
            loadNotifications(); // Refresh notifications when dropdown is opened
          }
        });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const companyNameEl = document.getElementById("companyname");
        const verifyBtn = document.getElementById("verifyNow");
        const verificationStatus =
          document.getElementById("verificationStatus");
        const addressEl = document.getElementById("address");

        // ‚úÖ Fetch donor details
        async function fetchDonorDetails() {
          try {
            const response = await fetch(`${baseUrl}/api/donor/status`, {
              method: "GET",
              credentials: "include",
            });
            const data = await response.json();

            if (response.ok) {
              companyNameEl.textContent = data.companyname || "Unknown Donor";
              addressEl.textContent = data.address || "Verify First";
              localStorage.setItem("donorcompanyname", data.companyname || "");
              const phoneEl = document.getElementById("phone");

              // Inside fetchDonorDetails function, after setting companyNameEl and addressEl
              phoneEl.textContent = data.phone || "";
            } else {
              console.error("Failed to fetch donor details:", data.message);
              companyNameEl.textContent = "Unknown Donor";
            }
          } catch (error) {
            console.error("Error fetching donor details:", error);
            companyNameEl.textContent = "Unknown Donor";
          }
        }

        // ‚úÖ Fetch verification status
        async function fetchVerificationStatus() {
          try {
            const response = await fetch(`${baseUrl}/api/donor/status`);
            const data = await response.json();

            if (!verificationStatus || !verifyBtn) return;

            const foodForm = document.getElementById("food-form");
            const unverifiedMessage =
              document.getElementById("unverified-message");
            const formInputs = foodForm.querySelectorAll(
              "input, select, button"
            );

            if (data.verified) {
              verifyBtn.innerText = "Verified ‚úÖ";
              verifyBtn.disabled = true;
              verifyBtn.classList.add("bg-[#74A57F]");
              verifyBtn.classList.add(
                "hover:bg-[#5d8a67]",
                "transition-colors",
                "duration-300"
              );

              // Enable food listing form
              unverifiedMessage.classList.add("hidden");
              formInputs.forEach((input) => {
                input.disabled = false;
                if (input.tagName === "BUTTON") {
                  input.classList.remove("opacity-50", "cursor-not-allowed");
                }
              });
            } else {
              verifyBtn.innerText = "Verify Now";
              verifyBtn.disabled = false;
              verifyBtn.classList.remove("bg-[#74A57F]");
              verifyBtn.classList.add("bg-[#74A57F]");
              verifyBtn.classList.remove(
                "hover:bg-[#5d8a67]",
                "transition-colors",
                "duration-300"
              );

              // Disable food listing form
              unverifiedMessage.classList.remove("hidden");
              formInputs.forEach((input) => {
                input.disabled = true;
                if (input.tagName === "BUTTON") {
                  input.classList.add("opacity-50", "cursor-not-allowed");
                }
              });
            }
          } catch (error) {
            console.error("Error fetching verification status:", error);
          }
        }

        // ‚úÖ Show modal on Verify Now
        if (verifyBtn) {
          verifyBtn.addEventListener("click", () => {
            document.getElementById("fssai-modal").classList.remove("hidden");
          });
        }

        // ‚úÖ Cancel modal
        document
          .getElementById("cancel-modal")
          .addEventListener("click", () => {
            document.getElementById("fssai-modal").classList.add("hidden");
          });

        // ‚úÖ Submit license
        document
          .getElementById("submit-license")
          .addEventListener("click", async () => {
            const licenseNo = document
              .getElementById("fssai-license-input")
              .value.trim();
            if (!licenseNo) {
              alert("Please enter your License/Registration No.");
              return;
            }

            // Add validation for license number length
            if (licenseNo.length < 14) {
              alert("Check your License, Invalid License/Registration No.");
              return;
            }

            if (
              !confirm(
                "Are you sure you want to submit this License/Registration No.?"
              )
            ) {
              return;
            }

            document.getElementById("fssai-modal").classList.add("hidden");

            try {
              const response = await fetch(`${baseUrl}/api/donor/verify`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ license: licenseNo }),
              });

              const data = await response.json();

              if (data.success && data.verified) {
                verifyBtn.innerText = "Verified ‚úÖ";
                verifyBtn.disabled = true;
                verifyBtn.classList.add("bg-[#74A57F]");
              }

              // Update address immediately without refreshing
              addressEl.textContent = data.address || "Address not available";
            } catch (error) {
              console.error("Verification Error:", error);
              verificationStatus.innerText =
                "‚ùå No records found. Invalid FSSAI number.";
            }
          });

        // ‚úÖ Logout
        document
          .getElementById("logout-btn")
          .addEventListener("click", function () {
            if (confirm("Are you sure you want to log out?")) {
              alert("You have been logged out.");
              localStorage.removeItem("donorcompanyname");
              fetch("/api/donor/logout").then(() => {
                window.location.href = "/donor_login.html";
              });
            }
          });

        // ‚úÖ Load on startup
        await fetchDonorDetails();
        await fetchVerificationStatus();
      });
    </script>
    <!-- Complaint Modal -->
    <div
      id="complaint-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"
    >
      <div class="bg-white text-black rounded-lg p-6 w-full max-w-md shadow-xl">
        <h2 class="text-xl font-bold mb-4">Raise a Complaint</h2>

        <label class="block mb-2">Title</label>
        <input
          type="text"
          id="complaint-title"
          class="w-full border border-gray-300 rounded p-2 mb-4"
          placeholder="Enter title..."
        />

        <label class="block mb-2">Description</label>
        <textarea
          id="complaint-desc"
          class="w-full border border-gray-300 rounded p-2 mb-4"
          rows="4"
          placeholder="Describe your issue..."
        ></textarea>

        <p class="text-sm text-gray-600 mb-4">
          Ticket Number: <span id="ticket-id" class="font-bold"></span>
        </p>

        <div class="flex justify-end gap-2">
          <button
            id="cancel-complaint"
            class="px-4 py-2 rounded bg-gray-400 text-white"
          >
            Cancel
          </button>
          <button
            id="submit-complaint"
            class="px-4 py-2 rounded bg-blue-600 text-white"
          >
            Submit
          </button>
        </div>
      </div>
    </div>

    <script>
      const complaintModal = document.getElementById("complaint-modal");
      const raiseComplaintBtn = document.getElementById("raiseComplaintBtn");
      const cancelComplaintBtn = document.getElementById("cancel-complaint");
      const submitComplaintBtn = document.getElementById("submit-complaint");

      raiseComplaintBtn.addEventListener("click", () => {
        document.getElementById("complaint-title").value = "";
        document.getElementById("complaint-desc").value = "";
        document.getElementById("ticket-id").textContent = generateTicketID();
        complaintModal.classList.remove("hidden");
      });

      cancelComplaintBtn.addEventListener("click", () => {
        complaintModal.classList.add("hidden");
      });

      submitComplaintBtn.addEventListener("click", () => {
        const title = document.getElementById("complaint-title").value.trim();
        const desc = document.getElementById("complaint-desc").value.trim();
        const ticketId = document.getElementById("ticket-id").textContent;

        if (!title || !desc) {
          alert("Please fill in all fields.");
          return;
        }

        const complaintData = {
          ticketId,
          title,
          description: desc,
          createdAt: new Date().toISOString(),
        };

        console.log("Complaint Submitted:", complaintData);

        // Send complaint to backend
        fetch(`${baseUrl}/api/complaints/raise`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include", // Important: Include cookies for session
          body: JSON.stringify(complaintData),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              alert(`Complaint submitted! Your ticket number is ${ticketId}`);
              complaintModal.classList.add("hidden");
            } else {
              alert("Failed to submit complaint. Try again.");
            }
          })
          .catch((err) => {
            console.error("Error submitting complaint:", err);
            alert("Something went wrong.");
          });
      });

      function generateTicketID() {
        return (
          "#" +
          Math.floor(Math.random() * 1000000)
            .toString()
            .padStart(6, "0")
        );
      }
    </script>

    <script>
      function showSuccessPopup() {
        const popup = document.getElementById("success-popup");
        popup.classList.remove("hidden");
      }

      function closeSuccessPopup() {
        const popup = document.getElementById("success-popup");
        popup.classList.add("hidden");
      }
    </script>

    <script>
      // Function to fetch and display reviews
      async function loadReviews() {
        try {
          // First get the donor's company name
          const donorResponse = await fetch(`${baseUrl}/api/donor/status`, {
            credentials: "include",
          });

          if (!donorResponse.ok) {
            throw new Error("Failed to fetch donor details");
          }

          const donorData = await donorResponse.json();
          console.log("Donor data:", donorData); // Debug log

          if (!donorData.companyname) {
            throw new Error("Company name not found");
          }

          // Fetch all donations for the donor
          const response = await fetch(`${baseUrl}/api/donor/donations`, {
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("Failed to fetch donations");
          }

          const data = await response.json();
          console.log("Donations data:", data); // Debug log

          const reviewsContainer = document.getElementById("reviews-container");
          const noReviews = document.getElementById("no-reviews");
          const averageRatingEl = document
            .getElementById("average-rating")
            .querySelector("span");

          // Filter donations that have reviews
          const reviews = data.donations.filter(
            (donation) =>
              donation.review &&
              donation.review.rating &&
              donation.review.comment
          );

          if (!reviews || reviews.length === 0) {
            reviewsContainer.innerHTML = "";
            noReviews.classList.remove("hidden");
            averageRatingEl.textContent = "0";
            return;
          }

          // Calculate average rating
          const totalRating = reviews.reduce(
            (sum, donation) => sum + donation.review.rating,
            0
          );
          const averageRating = (totalRating / reviews.length).toFixed(1);
          averageRatingEl.textContent = averageRating;

          noReviews.classList.add("hidden");
          reviewsContainer.innerHTML = reviews
            .map(
              (donation) => `
            <div class="bg-[#d5f7d5] p-4 rounded-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h3 class="font-bold text-lg">${
                    donation.receiverId?.nponame || "Unknown Receiver"
                  }</h3>
                  <p class="text-sm text-gray-500">${new Date(
                    donation.review.createdAt
                  ).toLocaleDateString()}</p>
                </div>
                <div class="flex items-center">
                  ${Array(5)
                    .fill()
                    .map(
                      (_, i) => `
                    <span class="text-2xl ${
                      i < (donation.review.rating || 0)
                        ? "text-yellow-400"
                        : "text-gray-300"
                    }">‚òÖ</span>
                  `
                    )
                    .join("")}
                </div>
              </div>
              <p class="text-gray-700">${
                donation.review.comment || "No comment provided"
              }</p>
              <div class="mt-2 text-sm text-gray-500">
                <p>Food Item: ${donation.title || "Not specified"}</p>
              </div>
            </div>
          `
            )
            .join("");
        } catch (error) {
          console.error("Error loading reviews:", error);
          const reviewsContainer = document.getElementById("reviews-container");
          reviewsContainer.innerHTML = `
            <div class="text-red-500 text-center py-4">
              ${
                error.message ||
                "Failed to load reviews. Please try again later."
              }
            </div>
          `;
        }
      }

      // Function to show reviews modal
      function showReviewsModal() {
        const modal = document.getElementById("reviews-modal");
        modal.classList.remove("hidden");
        loadReviews();
      }

      // Function to close reviews modal
      function closeReviewsModal() {
        const modal = document.getElementById("reviews-modal");
        modal.classList.add("hidden");
      }

      // Add click event listener to reviews link
      document
        .getElementById("reviews-link")
        .addEventListener("click", function (e) {
          e.preventDefault();
          showReviewsModal();
        });

      // Close modal when clicking outside
      document
        .getElementById("reviews-modal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeReviewsModal();
          }
        });
    </script>
  </body>
</html>
