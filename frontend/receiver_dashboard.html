<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Receiver Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Define baseUrl at the top level to be used by all scripts -->
    <script>
      const baseUrl = window.location.origin;
    </script>
    <style>
      /* Base Styles */
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: row;
      }

      .sidebar {
        width: 250px;
        background-color: #0b464a;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
      }

      main {
        margin-left: 250px;
        width: calc(100% - 250px);
        min-height: 100vh;
      }

      .bg-opacity {
        background-color: rgba(1, 73, 78, 0.6);
      }

      .notification-bell {
        position: absolute;
        right: 70px;
        cursor: pointer;
        font-size: 24px;
      }

      .notification-item {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .notification-item:hover {
        background-color: #f8f8f8;
      }

      .notification-item.unread {
        background-color: #e0c1a3;
      }

      .notification-item.unread:hover {
        background-color: #d4b494;
      }

      .notification-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: red;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        min-width: 18px;
        text-align: center;
      }

      .replies-section {
        margin-top: 20px;
        padding: 10px;
        background: #f6e6d8;
        border-radius: 8px;
      }

      .reply-item {
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border-radius: 5px;
      }

      .reply-item.agent {
        background: #e0c1a3;
      }

      /* Mobile Menu Button */
      .mobile-menu-btn {
        display: none;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: #0b464a;
        border: none;
        color: white;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
      }

      /* Responsive Styles */
      @media (max-width: 1024px) {
        .sidebar {
          width: 200px;
        }

        main {
          margin-left: 200px;
          width: calc(100% - 200px);
        }

        .notification-dropdown {
          width: 250px;
        }
      }

      @media (max-width: 768px) {
        body {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          position: fixed;
          left: -100%;
          top: 0;
          height: 100vh;
          z-index: 999;
          transition: left 0.3s ease;
        }

        .sidebar.active {
          left: 0;
        }

        .mobile-menu-btn {
          display: block;
        }

        main {
          margin-left: 0;
          width: 100%;
        }

        .header {
          padding: 15px;
          font-size: 1.2rem;
        }

        .notification-bell {
          right: 20px;
        }

        .notification-dropdown {
          width: 90%;
          max-width: 300px;
          right: 10px;
        }

        .grid-cols-2 {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 480px) {
        .header {
          padding: 10px;
          font-size: 1rem;
        }

        .notification-bell {
          font-size: 20px;
          right: 15px;
        }

        .notification-dropdown {
          width: 95%;
          right: 5px;
          max-height: calc(100vh - 60px);
        }

        .bg-white {
          padding: 15px;
        }

        h2 {
          font-size: 1.1rem;
        }

        p {
          font-size: 0.9rem;
        }
      }

      /* Existing Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
      }

      .donor-info {
        margin: 20px 0;
      }

      .donor-info p {
        margin: 10px 0;
      }

      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }

      .rating-container {
        text-align: center;
        margin: 20px 0;
      }

      .rating-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .rating-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #ddd;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .home-button {
        width: 100%;
        padding: 10px;
        background: #075261;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-bottom: 15px;
      }

      .home-button:hover {
        background: #064751;
      }

      .rating-btn.selected {
        background-color: #4caf50;
        color: white;
        border-color: #4caf50;
      }

      .rating-label {
        color: #666;
        font-size: 0.9em;
      }

      .comment-container {
        margin: 20px 0;
      }

      #commentTextarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
      }

      .notification-item {
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s;
      }

      .notification-item:last-child {
        border-bottom: none;
      }

      .notification-item:hover {
        background-color: #f3f4f6;
      }

      .notification-item.unread {
        background-color: #e0c1a3;
      }

      .notification-item.unread:hover {
        background-color: #d4b494;
      }

      .notification-bell-container {
        position: relative;
        display: inline-block;
      }

      .notification-dropdown {
        position: fixed;
        top: 100%;
        right: 0;
        width: 320px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-top: 0.5rem;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 1000;
      }

      .notification-dropdown.hidden {
        display: none !important;
      }

      .notification-item {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        transition: background-color 0.2s;
      }
    </style>
  </head>
  <body class="flex bg-opacity text-white">
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <!-- Sidebar -->
    <aside class="sidebar text-white p-5 min-h-screen">
      <h2 class="text-3xl font-bold">Aahar Link</h2>
      <div class="sidebar-spacing"></div>
      <nav>
        <ul>
          <li class="py-2">
            <button
              onclick="window.location.href='home.html'"
              class="home-button"
            >
              üè† Home
            </button>
          </li>
          <!--<li class="py-2">
            <a href="#" class="block" id="reviews-link">‚≠ê Reviews</a>
          </li>-->
          <!-- Logout Button -->
          <li class="py-96 mt-4"></li>
          <div class="mt-auto flex justify-center pb-4">
            <button
              id="logout-btn"
              class="bg-red-500 text-white px-4 py-2 rounded w-32"
            >
              Logout
            </button>
          </div>
        </ul>
      </nav>
    </aside>

    <script>
      function toggleSidebar() {
        const sidebar = document.querySelector(".sidebar");
        sidebar.classList.toggle("active");
      }
    </script>

    <script>
      document
        .getElementById("logout-btn")
        .addEventListener("click", function () {
          if (confirm("Are you sure you want to log out?")) {
            localStorage.removeItem("receiverId");
            localStorage.removeItem("receiverDetails");
            window.location.href = "/receiver_login.html";
          }
        });
    </script>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <header class="flex justify-between items-center mb-5 bg-[#0b464a] p-4">
        <h1
          class="text-2xl font-bold text-white text-center flex-1 tracking-wider"
        >
          RECEIVER DASHBOARD
        </h1>
        <div class="flex items-center gap-4">
          <div
            class="relative text-red-500 text-xl cursor-pointer"
            id="notification-btn"
          >
            üîî
            <span
              id="notification-count"
              class="absolute -top-2 -right-2 bg-red-500 text-white text-xs px-1 rounded-full"
            >
              0
            </span>
            <!-- Notifications Dropdown -->
            <div
              id="notification-dropdown"
              class="hidden fixed right-0 mt-3 w-80 bg-white border border-gray-300 rounded-lg shadow-lg z-50 p-4 space-y-2 text-sm"
            >
              <p class="text-gray-500">Loading...</p>
            </div>
          </div>
          <button
            id="raiseComplaintBtn"
            class="bg-[#075261] text-white text-sm px-3 py-1 rounded hover:bg-[#064751] transition"
          >
            üìù Raise Complaint
          </button>
        </div>
      </header>

      <!-- Receiver Details Section -->
      <div class="bg-white p-4 rounded-lg shadow-md mt-5 text-black">
        <h2 class="text-xl font-bold mb-3">Receiver Details</h2>
        <p>
          <strong>Name of NPO:</strong> <span id="npo-name">Loading...</span>
        </p>
        <!-- Default address set to "Verify First" -->
        <p>
          <strong>Address:</strong> <span id="npo-address">Verify First</span>
        </p>

        <!-- Add verification warning message -->
        <div
          id="unverified-message"
          class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4"
        >
          <p class="font-bold">Verification Required</p>
          <p>
            Please verify your account to request food donations. Click the
            "Verify Now" button above to proceed.
          </p>
        </div>

        <!-- Add verification button -->
        <button
          id="verifyNow"
          class="w-full mt-3 mb-4 bg-[#0b464a] text-white py-2 rounded"
        >
          Verify Now
        </button>
        <p id="verificationStatus" class="text-red-500 text-sm mt-2"></p>
        <p id="verificationTimeMessage" class="text-gray-600 text-sm mt-2 hidden">It usually takes 1-2 minutes for verification! PLEASE WAIT</p>
      </div>

      <!-- Available Food Listings -->
      <div class="bg-white p-4 rounded-lg shadow-md mt-5 text-black">
        <h2 class="text-xl font-bold mb-3">Available Food Listings</h2>
        <div class="overflow-x-auto">
          <table
            id="food-listings"
            class="w-full text-left border-collapse min-w-[800px]"
          >
            <thead>
              <tr>
                <th class="border-b p-2 w-1/7">Title</th>
                <th class="border-b p-2 w-1/7">Type</th>
                <th class="border-b p-2 w-1/7">Quantity</th>
                <th class="border-b p-2 w-1/7">Expiry Date</th>
                <th class="border-b p-2 w-1/7">Restaurant</th>
                <th class="border-b p-2 w-1/7">Reviews</th>
                <th class="border-b p-2 w-1/7">Status</th>
                <th class="border-b p-2 w-1/7">Request</th>
              </tr>
            </thead>
            <tbody>
              <!-- Listings will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Requested Food Section -->
      <div class="bg-white p-4 rounded-lg shadow-md mt-5 text-black">
        <h2 class="text-xl font-bold mb-3">Your Requests</h2>
        <div class="overflow-x-auto">
          <table
            id="request-list"
            class="w-full text-left border-collapse min-w-[600px]"
          >
            <thead>
              <tr>
                <th class="border-b p-2 w-1/4">Food Item</th>
                <th class="border-b p-2 w-1/4">Restaurant</th>
                <th class="border-b p-2 w-1/4">Status</th>
                <th class="border-b p-2 w-1/4">Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Requests will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Donation Cancelled Popup -->
    <div id="donation-cancelled-popup" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
      <div class="bg-white text-black rounded-lg p-6 w-full max-w-md shadow-xl">
        <h2 class="text-xl font-bold mb-4">Donation Cancelled</h2>
        <p id="cancellation-message" class="mb-4"></p>
        <div class="flex justify-end">
          <button onclick="closeCancellationPopup()" class="px-4 py-2 rounded bg-[#0B464A] text-white hover:bg-blue-700">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Complaint Modal -->
    <div
      id="complaint-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"
    >
      <div class="bg-white text-black rounded-lg p-6 w-full max-w-md shadow-xl">
        <h2 class="text-xl font-bold mb-4">Raise a Complaint</h2>
        <label class="block mb-2">Title</label>
        <input
          type="text"
          id="complaint-title"
          class="w-full border border-gray-300 rounded p-2 mb-4"
          placeholder="Enter title..."
        />
        <label class="block mb-2">Description</label>
        <textarea
          id="complaint-desc"
          class="w-full border border-gray-300 rounded p-2 mb-4"
          rows="4"
          placeholder="Describe your issue..."
        ></textarea>
        <p class="text-sm text-gray-600 mb-4">
          Ticket Number: <span id="ticket-id" class="font-bold"></span>
        </p>
        <div class="flex justify-end gap-2">
          <button
            id="cancel-complaint"
            class="px-4 py-2 rounded bg-gray-400 text-white"
          >
            Cancel
          </button>
          <button
            id="submit-complaint"
            class="px-4 py-2 rounded bg-[#0B464A] text-white hover:bg-blue-700"
          >
            Submit
          </button>
        </div>
      </div>
    </div>

    <!-- Include receiver.js for handling verification and other functions -->
    <script>
      // Function to fetch food listings from the API
      async function fetchFoodListings() {
        try {
          const response = await fetch("/api/donations/active");
          if (!response.ok) {
            throw new Error("Failed to fetch food listings");
          }
          const listings = await response.json();
          console.log("Received food listings:", listings); // Debug log

          const tableBody = document.querySelector("#food-listings tbody");
          if (!tableBody) {
            console.error("Food listings table body not found");
            return;
          }

          tableBody.innerHTML = "";

          if (!Array.isArray(listings) || listings.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" class="p-2 text-gray-500 text-center">
                  No food listings available
                </td>
              </tr>
            `;
            return;
          }

          // Get verification status
          const verificationResponse = await fetch(
            `${baseUrl}/api/receiver/details`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                nponame: localStorage.getItem("receivernponame"),
              }),
              credentials: "include",
            }
          );
          const verificationData = await verificationResponse.json();
          const isVerified = verificationData.verified;

          listings.forEach((listing) => {
            const donorName =
              listing.donorId?.companyname ||
              listing.donorId?.name ||
              listing.donorId?.nponame ||
              "Unknown Restaurant";

            const row = document.createElement("tr");
            row.innerHTML = `
          <td class="p-2">${listing.title}</td>
          <td class="p-2 ${
            listing.type === "veg" ? "text-green-500" : "text-red-500"
          }">${listing.type}</td>
          <td class="p-2">${listing.quantity}</td>
              <td class="p-2">${new Date(
                listing.expiryDate
              ).toLocaleDateString()}</td>
              <td class="p-2">${donorName}</td>
              <td class="p-2">
                <button 
                  class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors"
                  onclick="showRestaurantReviews('${listing.donorId?._id || ''}')"
                >
                  Check Reviews
                </button>
              </td>
              <td class="p-2 ${
                listing.status === "Active"
                  ? "text-green-500"
                  : listing.status === "Expired"
                  ? "text-red-500"
                  : listing.status === "Claimed"
                  ? "text-yellow-500"
                  : listing.status === "Confirmed"
                  ? "text-blue-500"
                  : "text-gray-500"
              }">${listing.status}</td>
          <td class="p-2">
              ${
                listing.status === "Active"
                  ? `
                <button 
                  class="bg-blue-500 text-white px-3 py-1 rounded ${
                    !isVerified ? "opacity-50 cursor-not-allowed" : ""
                  }"
                  onclick="sendFoodRequest('${listing._id}')"
                  ${!isVerified ? "disabled" : ""}
                >
                  Request
                </button>
              `
                  : ""
              }
          </td>
        `;
            tableBody.appendChild(row);
          });

          // Show/hide verification warning message
          const unverifiedMessage =
            document.getElementById("unverified-message");
          if (unverifiedMessage) {
            unverifiedMessage.classList.toggle("hidden", isVerified);
          }
        } catch (error) {
          console.error("Error fetching listings:", error);
          const tableBody = document.querySelector("#food-listings tbody");
          if (tableBody) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" class="p-2 text-red-500 text-center">
                  Failed to load food listings. Please try again.
                </td>
              </tr>
            `;
          }
        }
      }

      // Function to fetch and display receiver details
      async function fetchReceiverDetails() {
        const nponame = localStorage.getItem("receivernponame");
        if (!nponame) {
          console.error("NPO name not found in localStorage");
          return;
        }

        try {
          const response = await fetch(`${baseUrl}/api/receiver/details`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ nponame }),
          });

          const data = await response.json();
          if (data.success) {
            // Store receiverId in localStorage
            if (data._id) {
              localStorage.setItem("receiverId", data._id);
            }

            // Store receiver details in localStorage for persistence
            localStorage.setItem(
              "receiverDetails",
              JSON.stringify({
                nponame: data.nponame,
                address: data.address,
                verified: data.verified,
              })
            );

            // Update UI with receiver details
            document.getElementById("npo-name").textContent = data.nponame;
            document.getElementById("npo-address").textContent = data.verified
              ? data.address
              : "Verify First";

            // Update verification button
            const verifyBtn = document.getElementById("verifyNow");
            if (verifyBtn) {
              verifyBtn.textContent = data.verified
                ? "Verified ‚úÖ"
                : "Verify Now";
              verifyBtn.disabled = data.verified;
            }

            // Refresh requests and notifications after getting fresh data
            await Promise.all([fetchReceiverRequests(), loadNotifications()]);
          } else {
            console.error("Failed to fetch receiver details:", data.message);
            // Try to use cached data if fetch fails
            const cachedDetails = localStorage.getItem("receiverDetails");
            if (cachedDetails) {
              const cachedData = JSON.parse(cachedDetails);
              document.getElementById("npo-name").textContent =
                cachedData.nponame;
              document.getElementById("npo-address").textContent =
                cachedData.verified ? cachedData.address : "Verify First";
            }
          }
        } catch (error) {
          console.error("Error fetching receiver details:", error);
          // Try to use cached data if fetch fails
          const cachedDetails = localStorage.getItem("receiverDetails");
          if (cachedDetails) {
            const cachedData = JSON.parse(cachedDetails);
            document.getElementById("npo-name").textContent =
              cachedData.nponame;
            document.getElementById("npo-address").textContent =
              cachedData.verified ? cachedData.address : "Verify First";
          }
        }
      }

      // Function to fetch and store receiver ID
      async function fetchAndStoreReceiverId() {
        try {
          const nponame = localStorage.getItem("receivernponame");
          if (!nponame) {
            console.error("No NPO name found in localStorage");
            return;
          }

          const response = await fetch(`${baseUrl}/api/receiver/details`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ nponame }),
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("Received data for ID:", data); // Debug log

          if (data.success) {
            // Store the receiver ID in localStorage
            if (data._id) {
              localStorage.setItem("receiverId", data._id);
              console.log("Stored receiverId:", data._id); // Debug log
            } else if (data.Receiver && data.Receiver._id) {
              localStorage.setItem("receiverId", data.Receiver._id);
              console.log(
                "Stored receiverId from Receiver object:",
                data.Receiver._id
              ); // Debug log
            } else if (data.receiverId) {
              localStorage.setItem("receiverId", data.receiverId);
              console.log(
                "Stored receiverId from receiverId field:",
                data.receiverId
              ); // Debug log
            }
          }
        } catch (error) {
          console.error("Error fetching receiver ID:", error);
        }
      }

      // Function to send food request
      async function sendFoodRequest(donationId) {
        try {
          // Check verification status first
          const verificationResponse = await fetch(
            `${baseUrl}/api/receiver/details`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                nponame: localStorage.getItem("receivernponame"),
              }),
              credentials: "include",
            }
          );

          const verificationData = await verificationResponse.json();

          if (!verificationData.verified) {
            alert(
              "Please verify your account before requesting food donations."
            );
            return;
          }

          // Get receiver ID from localStorage
          let receiverId = localStorage.getItem("receiverId");
          console.log("Current receiverId from localStorage:", receiverId); // Debug log

          // If no receiverId, try to fetch it first
          if (!receiverId) {
            console.log("No receiverId found, fetching ID..."); // Debug log
            await fetchAndStoreReceiverId();
            receiverId = localStorage.getItem("receiverId");
            console.log("New receiverId after fetch:", receiverId); // Debug log

            if (!receiverId) {
              throw new Error("Please log in again. No receiver ID found.");
            }
          }

          // Validate receiver ID
          if (
            !receiverId ||
            receiverId === "undefined" ||
            receiverId === "null"
          ) {
            console.error("Invalid receiver ID format:", receiverId);
            throw new Error("Invalid receiver ID. Please log in again.");
          }

          // Make the request
          const response = await fetch(`/api/donations/request/${donationId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              receiverId: receiverId,
              status: "Claimed", // Explicitly set status to Claimed
            }),
            credentials: "include",
          });

          // Handle response
          if (!response.ok) {
            const errorData = await response.json();
            console.error("Request error response:", errorData); // Debug log
            throw new Error(errorData.message || "Failed to send request");
          }

          const data = await response.json();
          console.log("Request successful response:", data); // Debug log

          if (data.success) {
            alert("Request sent successfully!");
            // Refresh both the food listings and requests list
            await Promise.all([fetchFoodListings(), fetchReceiverRequests()]);
          } else {
            throw new Error(data.message || "Failed to send request");
          }
        } catch (error) {
          console.error("Error sending request:", error);
          alert(error.message || "Failed to send request. Please try again.");
        }
      }

      // Function to check for new notifications
      async function checkNotifications() {
        try {
          const response = await fetch("/api/notifications", {
            credentials: "include",
          });
          const notifications = await response.json();

          const notificationCount =
            document.getElementById("notification-count");
          const notificationDropdown = document.getElementById(
            "notification-dropdown"
          );

          notificationCount.textContent = notifications.length;

          if (notifications.length > 0) {
            notificationDropdown.innerHTML = notifications
              .map(
                (notification) => `
            <div class="border-b border-gray-200 py-2 text-black">
              <p class="font-bold">${notification.title}</p>
              <p class="text-sm text-gray-600">${notification.message}</p>
              <p class="text-xs text-gray-400">${new Date(
                notification.createdAt
              ).toLocaleString()}</p>
            </div>
          `
              )
              .join("");

            // Check for donation approval notifications
            notifications.forEach((notification) => {
              if (notification.title === "Donation Approved") {
                // Update the status in the requests list
                const requestRows = document.querySelectorAll(
                  "#request-list tbody tr"
                );
                requestRows.forEach((row) => {
                  const collectBtn = row.querySelector(".collect-btn");
                  if (
                    collectBtn &&
                    collectBtn.dataset.id === notification.donationId
                  ) {
                    // Update status to Confirmed
                    const statusCell = row.querySelector("td:nth-child(3)");
                    statusCell.textContent = "Confirmed";
                    statusCell.className = "p-2 text-green-500";

                    // Show collect button
                    collectBtn.classList.remove("hidden");
                  }
                });
              }
            });
          } else {
            notificationDropdown.innerHTML =
              '<p class="text-gray-500">No new notifications</p>';
          }
        } catch (error) {
          console.error("Error checking notifications:", error);
        }
      }

      // Function to fetch receiver's requests
      async function fetchReceiverRequests() {
        try {
          const receiverId = localStorage.getItem("receiverId");
          console.log("Fetching requests for receiver:", receiverId); // Debug log

          if (!receiverId) {
            console.error("No receiver ID found in localStorage");
            return;
          }

          const cleanReceiverId = receiverId.toString().trim();
          console.log("Cleaned receiverId:", cleanReceiverId); // Debug log

          const response = await fetch(
            `/api/donations/receiver-requests?receiverId=${cleanReceiverId}`,
            {
              credentials: "include",
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            console.error("Server error response:", errorData);
            return;
          }

          const requests = await response.json();
          console.log("Received requests:", requests);

          if (!Array.isArray(requests)) {
            console.error("Invalid response format:", requests);
            return;
          }

          const requestList = document.querySelector("#request-list tbody");
          if (!requestList) {
            console.error("Request list table not found");
            return;
          }

          requestList.innerHTML = "";

          if (requests.length === 0) {
            requestList.innerHTML = `
              <tr>
                <td colspan="4" class="p-2 text-gray-500 text-center">
                  No requests found
                </td>
              </tr>
            `;
            return;
          }

          requests.forEach((request) => {
            const row = document.createElement("tr");
            const statusColor =
              request.status === "Pending"
                ? "text-yellow-500"
                : request.status === "Confirmed"
                ? "text-green-500"
                : request.status === "Claimed"
                ? "text-yellow-500"
                : "text-gray-500";

            const donorName =
              request.donorId?.companyname ||
              request.donorId?.name ||
              "Unknown Restaurant";

            row.innerHTML = `
              <td class="p-2">${request.title}</td>
              <td class="p-2">${donorName}</td>
              <td class="p-2 ${statusColor}">${request.status}</td>
              <td class="p-2">
                ${
                  request.status === "Confirmed"
                    ? `
                  <button class="bg-green-500 text-white px-2 py-1 rounded collect-btn" 
                    data-id="${request._id}">
                    Collect
                  </button>
                `
                    : ""
                }
              </td>
      `;
            requestList.appendChild(row);
          });

          // Add event listeners to collect buttons
          document.querySelectorAll(".collect-btn").forEach((button) => {
            button.addEventListener("click", function () {
              markAsCollected(this.dataset.id);
            });
          });
        } catch (error) {
          console.error("Error fetching requests:", error);
        }
      }

      // Function to update the UI with receiver details
      function updateReceiverUI(data) {
        console.log("Updating UI with data:", data); // Debug log

        const npoNameElement = document.getElementById("npo-name");
        const npoAddressElement = document.getElementById("npo-address");
        const verifyBtn = document.getElementById("verifyNow");

        if (npoNameElement) {
          npoNameElement.textContent =
            data.nponame || data.Receiver?.nponame || "Unknown NPO";
        }

        if (npoAddressElement) {
          npoAddressElement.textContent =
            data.address || data.Receiver?.address || "Verify First";
        }

        if (verifyBtn) {
          const isVerified = data.verified || data.Receiver?.verified;
          if (isVerified) {
            verifyBtn.innerText = "Verified ‚úÖ";
            verifyBtn.disabled = true;
            verifyBtn.classList.add("bg-[#0B464A]");
          } else {
            verifyBtn.innerText = "Verify Now";
            verifyBtn.disabled = false;
            verifyBtn.classList.remove("bg-[#0B464A]");
            verifyBtn.classList.add(
              "bg-[#0B464A]",
              "hover:bg-[#5d8a67]",
              "text-white",
              "px-4",
              "py-2",
              "rounded"
            );
          }
        }
      }

      // Function to check for cancelled donations
      async function checkCancelledDonations() {
        try {
          const response = await fetch('/api/donations/requests', {
            credentials: 'include'
          });
          const data = await response.json();
          
          // Ensure we have an array of requests
          const requests = Array.isArray(data) ? data : (data.requests || []);
          
          // Get the last request that was cancelled
          const cancelledRequest = requests.find(request => request.status === 'Cancelled');
          if (cancelledRequest && cancelledRequest.donorId) {
            const companyName = cancelledRequest.donorId.companyname || 'Unknown Company';
            showCancellationPopup(companyName);
          }
        } catch (error) {
          console.error('Error checking cancelled donations:', error);
        }
      }

      // Function to show donation cancelled popup
      function showCancellationPopup(companyName) {
        const popup = document.getElementById('donation-cancelled-popup');
        const message = document.getElementById('cancellation-message');
        if (popup && message) {
          message.textContent = `The donation has been cancelled by ${companyName}`;
          popup.classList.remove('hidden');
          
          // Add event listener to close popup when clicking outside
          popup.addEventListener('click', (e) => {
            if (e.target === popup) {
              closeCancellationPopup();
            }
          });
        }
      }

      // Function to close donation cancelled popup
      function closeCancellationPopup() {
        const popup = document.getElementById('donation-cancelled-popup');
        if (popup) {
          popup.classList.add('hidden');
        }
      }

      // Initialize the dashboard
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("DOM Content Loaded"); // Debug log

        // First try to use cached data
        const cachedDetails = localStorage.getItem("receiverDetails");
        if (cachedDetails) {
          const cachedData = JSON.parse(cachedDetails);
          document.getElementById("npo-name").textContent = cachedData.nponame;
          document.getElementById("npo-address").textContent =
            cachedData.verified ? cachedData.address : "Verify First";
        }

        // Then fetch fresh data
        await Promise.all([
          fetchReceiverDetails(),
          fetchFoodListings(),
          loadNotifications(),
          checkCancelledDonations()
        ]);

        // Set up periodic refresh
        setInterval(async () => {
          await Promise.all([
            fetchReceiverDetails(),
            fetchFoodListings(),
            loadNotifications(),
            checkCancelledDonations()
          ]);
        }, 30000); // Refresh every 30 seconds
      });

      // Update verification button click handler
      document
        .getElementById("verifyNow")
        .addEventListener("click", async function () {
          try {
            const nponame = localStorage.getItem("receivernponame");
            console.log("Current nponame:", nponame); // Debug log

            if (!nponame) {
              throw new Error("NPO name not found. Please log in again.");
            }

            // Show verifying status
            this.innerText = "Verifying...";
            this.disabled = true;
            document.getElementById("verificationTimeMessage").classList.remove("hidden");

            // First fetch the receiver details to get the registration number
            const response = await fetch(`${baseUrl}/api/receiver/details`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ nponame }),
              credentials: "include",
            });

            if (!response.ok) {
              const errorData = await response.json();
              console.error("Error response:", errorData); // Debug log
              throw new Error(
                errorData.message || "Failed to fetch receiver details"
              );
            }

            const data = await response.json();
            console.log("Full response data:", data); // Debug log

            if (!data.success) {
              throw new Error(
                data.message || "Failed to fetch receiver details"
              );
            }

            // Get the registration number from the session data
            const regno = data.regno;
            console.log("Found registration number:", regno); // Debug log

            if (!regno) {
              throw new Error("Registration number not found for this NPO");
            }

            // Call verifyNgo function with the registration number
            const verifyResponse = await fetch(
              `${baseUrl}/api/receiver/verify`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify({
                  nponame: nponame,
                  regno: regno,
                }),
              }
            );

            const verifyData = await verifyResponse.json();
            console.log("Verification response:", verifyData); // Debug log

            if (verifyResponse.ok && verifyData.success) {
              alert("Verification successful!");
              // Update the UI to show verified status
              this.innerText = "Verified ‚úÖ";
              this.disabled = true;
              this.classList.add("bg-[#0B464A]");
              document.getElementById("verificationTimeMessage").classList.add("hidden");

              // Update address if provided
              if (verifyData.address) {
                document.getElementById("npo-address").textContent =
                  verifyData.address;
              }

              // Refresh receiver details
              fetchReceiverDetails();
            } else {
              alert("Verification failed");
              // Reset button state
              this.innerText = "Verify Now";
              this.disabled = false;
              document.getElementById("verificationTimeMessage").classList.add("hidden");
            }
          } catch (error) {
            console.error("Error during verification:", error);
            alert(error.message || "Verification failed. Please try again.");
            // Reset button state
            this.innerText = "Verify Now";
            this.disabled = false;
            document.getElementById("verificationTimeMessage").classList.add("hidden");
          }
        });
    </script>

    <!-- Common variables -->
    <script>
      // Remove baseUrl declaration since it's now at the top
    </script>

    <!-- Donor Details Modal -->
    <div
      id="donor-details-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"
    >
      <div class="bg-white text-black rounded-lg p-6 w-full max-w-md shadow-xl">
        <h2 class="text-xl font-bold mb-4">Collect Your Food</h2>

        <div class="mb-4">
          <p class="font-bold">
            Food Item: <span id="donation-title" class="font-normal"></span>
          </p>
          <p class="font-bold">
            Donor Name: <span id="donor-name" class="font-normal"></span>
          </p>
          <p class="font-bold">
            Pickup Address: <span id="donor-address" class="font-normal"></span>
          </p>
        </div>

        <div class="bg-yellow-100 p-3 rounded mb-4">
          <p class="text-yellow-800">
            Please collect your food from the above address. Make sure to bring
            a valid ID for verification.
          </p>
        </div>

        <div class="flex justify-end gap-2">
          <button
            id="cancel-collection"
            class="px-4 py-2 rounded bg-gray-400 text-white"
          >
            Cancel
          </button>
          <button
            id="confirm-collection"
            class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700"
          >
            Confirm Collection
          </button>
        </div>
      </div>
    </div>

    <!-- Complaint Modal Logic-->
    <script>
      const complaintModal = document.getElementById("complaint-modal");
      const raiseComplaintBtn = document.getElementById("raiseComplaintBtn");
      const cancelComplaintBtn = document.getElementById("cancel-complaint");
      const submitComplaintBtn = document.getElementById("submit-complaint");

      raiseComplaintBtn.addEventListener("click", () => {
        document.getElementById("complaint-title").value = "";
        document.getElementById("complaint-desc").value = "";
        document.getElementById("ticket-id").textContent = generateTicketID();
        complaintModal.classList.remove("hidden");
      });

      cancelComplaintBtn.addEventListener("click", () => {
        complaintModal.classList.add("hidden");
      });

      submitComplaintBtn.addEventListener("click", async () => {
        const title = document.getElementById("complaint-title").value.trim();
        const desc = document.getElementById("complaint-desc").value.trim();
        const ticketId = document.getElementById("ticket-id").textContent;

        if (!title || !desc) {
          alert("Please fill in all fields.");
          return;
        }

        const complaintData = {
          ticketId,
          title,
          description: desc,
          createdAt: new Date().toISOString(),
        };

        try {
          const response = await fetch("/api/complaints/raise", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify(complaintData),
          });

          const data = await response.json();

          if (data.success) {
            alert(`Complaint submitted! Your ticket number is ${ticketId}`);
            complaintModal.classList.add("hidden");
            // Refresh notifications after submitting complaint
            await loadNotifications();
          } else {
            alert(data.message || "Failed to submit complaint. Please try again.");
          }
        } catch (error) {
          console.error("Error submitting complaint:", error);
          alert("Something went wrong. Please try again.");
        }
      });

      function generateTicketID() {
        return (
          "#" +
          Math.floor(Math.random() * 1000000)
            .toString()
            .padStart(6, "0")
        );
      }
    </script>

    <script>
      function showSuccessPopup() {
        const popup = document.getElementById("success-popup");
        popup.classList.remove("hidden");
      }

      function closeSuccessPopup() {
        const popup = document.getElementById("success-popup");
        popup.classList.add("hidden");
      }
    </script>

    <!-- Notification handling script -->
    <script>
      let notifications = [];
      const notificationBell = document.getElementById("notification-btn");
      const notificationDropdown = document.getElementById("notification-dropdown");
      let isDropdownVisible = false;

      // Toggle notification dropdown
      notificationBell.addEventListener("click", () => {
        isDropdownVisible = !isDropdownVisible;
        notificationDropdown.classList.toggle("hidden");
        if (isDropdownVisible) {
          loadNotifications();
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", (event) => {
        if (!notificationBell.contains(event.target) && !notificationDropdown.contains(event.target)) {
          isDropdownVisible = false;
          notificationDropdown.classList.add("hidden");
        }
      });

      async function loadNotifications() {
        try {
          const response = await fetch("/api/complaints/notifications", {
            credentials: "include"
          });
          
          const data = await response.json();
          
          if (data.success) {
            notifications = data.notifications;
            updateNotificationUI();
          } else {
            console.error("Failed to load notifications:", data.message);
          }
        } catch (error) {
          console.error("Error loading notifications:", error);
        }
      }

      function updateNotificationUI() {
        const dropdown = document.getElementById("notification-dropdown");
        const count = document.getElementById("notification-count");

        // Update notification count
        const unreadCount = notifications.filter((n) => !n.read).length;
        count.textContent = unreadCount || "";
        count.style.display = unreadCount ? "block" : "none";

        // Update dropdown content
        if (notifications.length === 0) {
          dropdown.innerHTML = "<div class='p-4 text-center text-gray-500'>No notifications</div>";
        } else {
          dropdown.innerHTML = notifications
            .map((notification) => `
              <div class="notification-item ${notification.read ? "" : "unread"}" 
                   onclick="handleNotificationClick('${notification._id}', '${notification.ticketId}')">
                <p class="text-sm font-medium">${notification.message}</p>
                <small class="text-xs text-gray-500">${new Date(notification.timestamp).toLocaleString()}</small>
              </div>
            `)
            .join("");
        }
      }

      async function handleNotificationClick(notificationId, ticketId) {
        try {
          // Mark notification as read
          const readResponse = await fetch(
            `/api/complaints/notifications/${notificationId}/read`,
            {
              method: "PUT",
              credentials: "include"
            }
          );

          if (!readResponse.ok) {
            throw new Error("Failed to mark notification as read");
          }

          // Get complaint details
          const complaintsResponse = await fetch("/api/complaints/all", {
            credentials: "include"
          });
          
          const data = await complaintsResponse.json();

          if (data.success) {
            const ticket = data.complaints.find((t) => t.ticketId === ticketId);
            if (ticket) {
              showTicketDetails(ticket);
              await loadNotifications(); // Refresh notifications
            }
          }
        } catch (error) {
          console.error("Error handling notification:", error);
        }
      }

      function showTicketDetails(ticket) {
        // Remove any existing ticket modal
        const existingModal = document.querySelector('.modal-ticket-reply');
        if (existingModal) {
          existingModal.remove();
        }

        // Create modal element
        const modal = document.createElement("div");
        modal.className = "modal-ticket-reply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50";
        modal.innerHTML = `
          <div class="bg-white text-black rounded-lg shadow-lg w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-6 flex-none border-b">
              <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Ticket #${ticket.ticketId}</h3>
                <button onclick="this.closest('.modal-ticket-reply').remove()" class="text-gray-500 hover:text-gray-700">‚úï</button>
              </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
              <p class="mb-2"><strong>Status:</strong> ${ticket.status}</p>
              <p class="mb-2"><strong>Title:</strong> ${ticket.title}</p>
              <p class="mb-4"><strong>Description:</strong> ${ticket.description}</p>
              <div class="replies-section">
                <h4 class="font-bold mb-2">Replies:</h4>
                ${ticket.replies ? ticket.replies
                  .map(
                    (reply) => `
                    <div class="reply-item ${reply.sender === "agent" ? "agent" : ""} mb-2">
                      <p><strong>${reply.sender === "agent" ? "Customer Support" : "You"}:</strong></p>
                      <p>${reply.message}</p>
                      <small>${new Date(reply.timestamp).toLocaleString()}</small>
                    </div>
                  `
                  )
                  .join("") : '<p>No replies yet</p>'}
              </div>
            </div>
            ${
              ticket.status === "Open"
                ? `
                <div class="p-6 flex-none border-t">
                  <h4 class="font-bold mb-2">Reply:</h4>
                  <textarea id="reply-text" rows="4" class="w-full border rounded p-2 mb-2" placeholder="Type your reply here..."></textarea>
                  <button onclick="submitReply('${ticket._id}')" class="bg-[#0B464A] text-white px-4 py-2 rounded hover:bg-[#0a3f43]">Submit Reply</button>
                </div>
              `
                : ""
            }
          </div>
        `;
        document.body.appendChild(modal);
      }

      async function submitReply(ticketId) {
        const replyText = document.getElementById("reply-text").value.trim();
        if (!replyText) {
          alert("Please enter a reply");
          return;
        }

        try {
          // Check if the complaint is still open
          const checkRes = await fetch("/api/complaints/all", {
            credentials: "include",
          });
          const checkData = await checkRes.json();

          if (checkData.success) {
            const ticket = checkData.complaints.find((t) => t._id === ticketId);
            if (!ticket || ticket.status !== "Open") {
              alert("Cannot reply to a resolved complaint");
              return;
            }

            const response = await fetch(
              `/api/complaints/update/${ticketId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify({
                  reply: replyText,
                  sender: "user"
                }),
              }
            );

            const data = await response.json();
            if (data.success) {
              alert("Reply submitted successfully");
              // Remove the modal
              const modal = document.querySelector(".modal-ticket-reply");
              if (modal) {
                modal.remove();
              }
              // Refresh notifications
              await loadNotifications();
            } else {
              throw new Error(data.message || "Failed to submit reply");
            }
          }
        } catch (error) {
          console.error("Error submitting reply:", error);
          alert("Failed to submit reply. Please try again.");
        }
      }

      // Load notifications when page loads
      document.addEventListener("DOMContentLoaded", loadNotifications);
    </script>
    <script>
      // Function to mark donation as collected and show review modal
      async function markAsCollected(donationId) {
        try {
          // First fetch donation details to get donor info
          const response = await fetch(`/api/donations/${donationId}`);
          if (!response.ok) {
            throw new Error("Failed to fetch donation details");
          }
          const donation = await response.json();

          // Show donor details modal
          const donorDetailsModal = document.getElementById(
            "donor-details-modal"
          );
          const foodTitle = document.getElementById("donation-title");
          const donorName = document.getElementById("donor-name");
          const pickupAddress = document.getElementById("donor-address");

          // Get donor details from the populated donorId field
          const donorDetails = donation.donorId;

          foodTitle.textContent = donation.title;
          donorName.textContent =
            donorDetails.companyname || donorDetails.name || "Unknown Donor";
          pickupAddress.textContent =
            donorDetails.address || "Address not available";

          donorDetailsModal.classList.remove("hidden");

          // Handle confirm collection
          document.getElementById("confirm-collection").onclick = async () => {
            try {
              const collectResponse = await fetch(
                `/api/donations/collect/${donationId}`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                }
              );

              if (!collectResponse.ok) {
                const errorData = await collectResponse.json();
                throw new Error(
                  errorData.message || "Failed to confirm collection"
                );
              }

              // Close donor details modal
              donorDetailsModal.classList.add("hidden");

              // Redirect to rating page with donation ID
              window.location.href = `/rating.html?donationId=${donationId}`;
            } catch (error) {
              console.error("Collection confirmation error:", error);
              alert(
                error.message ||
                  "Failed to confirm collection. Please try again."
              );
            }
          };

          // Handle cancel collection
          document.getElementById("cancel-collection").onclick = () => {
            donorDetailsModal.classList.add("hidden");
          };
        } catch (error) {
          console.error("Donation details fetch error:", error);
          alert("Failed to fetch donation details. Please try again.");
        }
      }
    </script>
    <!-- Review Modal -->
    <div
      id="review-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"
    >
      <div class="bg-white text-black rounded-lg p-6 w-full max-w-md shadow-xl">
        <h2 class="text-xl font-bold mb-4">Rate Your Experience</h2>

        <div class="flex justify-center space-x-2 mb-4">
          <button class="star-btn text-2xl" data-rating="1">‚≠ê</button>
          <button class="star-btn text-2xl" data-rating="2">‚≠ê</button>
          <button class="star-btn text-2xl" data-rating="3">‚≠ê</button>
          <button class="star-btn text-2xl" data-rating="4">‚≠ê</button>
          <button class="star-btn text-2xl" data-rating="5">‚≠ê</button>
        </div>

        <label class="block mb-2">Comments</label>
        <textarea
          id="review-comment"
          class="w-full border border-gray-300 rounded p-2 mb-4"
          rows="4"
          placeholder="Share your experience..."
        ></textarea>

        <div class="flex justify-end gap-2">
          <button
            id="cancel-review"
            class="px-4 py-2 rounded bg-gray-400 text-white"
          >
            Cancel
          </button>
          <button
            id="submit-review"
            class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
          >
            Submit
          </button>
        </div>
      </div>
    </div>
    <script>
      // Add event listeners for rating buttons
      document.querySelectorAll(".rating-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".rating-btn")
            .forEach((b) => b.classList.remove("selected"));
          btn.classList.add("selected");
        });
      });
    </script>
    <!-- Restaurant Reviews Modal -->
    <div
      id="restaurant-reviews-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-2 sm:p-4"
    >
      <div class="bg-white text-black rounded-lg p-4 sm:p-6 w-full max-w-2xl max-h-[95vh] sm:max-h-[90vh] flex flex-col relative">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg sm:text-xl font-bold">Receiver Reviews</h2>
          <button
            id="close-reviews-modal"
            class="text-gray-500 hover:text-gray-700 text-xl p-1"
          >
            ‚úï
          </button>
        </div>
        <div class="text-gray-600 mb-4 text-sm sm:text-base">
          Average Rating: <span id="average-rating" class="font-bold">0</span>/5
        </div>
        <div id="reviews-container" class="flex-1 overflow-y-auto space-y-3 min-h-0 pr-2">
          <!-- Reviews will be dynamically inserted here -->
        </div>
        <div id="no-reviews-message" class="text-center text-gray-500 hidden py-4">
          No reviews available for this restaurant yet.
        </div>
      </div>
    </div>

    <script>
      // Function to show restaurant reviews
      async function showRestaurantReviews(donorId) {
        if (!donorId) {
          alert("No restaurant information available");
          return;
        }

        const modal = document.getElementById("restaurant-reviews-modal");
        const reviewsContainer = document.getElementById("reviews-container");
        const noReviewsMessage = document.getElementById("no-reviews-message");
        const averageRatingEl = document.getElementById("average-rating");

        try {
          const response = await fetch(`/api/reviews/restaurant/${donorId}`);
          if (!response.ok) {
            throw new Error("Failed to fetch reviews");
          }

          const data = await response.json();
          
          if (data.success && data.reviews.length > 0) {
            // Calculate average rating to match donor dashboard
            const totalRating = data.reviews.reduce((sum, review) => sum + review.rating, 0);
            const avgRating = totalRating / data.reviews.length;
            // Round to nearest 0.1 and ensure one decimal place
            const roundedRating = Math.round(avgRating * 10) / 10;
            averageRatingEl.textContent = roundedRating.toFixed(1);

            reviewsContainer.innerHTML = data.reviews
              .map(
                (review) => `
              <div class="bg-blue-50 rounded-lg p-3 sm:p-4">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                  <div class="flex flex-wrap items-center gap-2">
                    <div class="flex text-yellow-400 text-lg sm:text-xl">
                      ${Array(5)
                        .fill()
                        .map((_, i) => `<span>${i < review.rating ? '‚òÖ' : '‚òÜ'}</span>`)
                        .join("")}
                    </div>
                    <span class="text-xs sm:text-sm text-gray-500">
                      ${new Date(review.createdAt).toLocaleDateString()}
                    </span>
                  </div>
                </div>
                <p class="text-gray-700 my-2 text-sm sm:text-base break-words">${review.comment}</p>
                <p class="text-xs sm:text-sm text-gray-500">Food Item: ${review.foodItem}</p>
              </div>
            `
              )
              .join("");
            noReviewsMessage.classList.add("hidden");
            reviewsContainer.classList.remove("hidden");
          } else {
            reviewsContainer.innerHTML = "";
            noReviewsMessage.classList.remove("hidden");
            reviewsContainer.classList.add("hidden");
            averageRatingEl.textContent = "0.0";
          }

          modal.classList.remove("hidden");
        } catch (error) {
          console.error("Error fetching reviews:", error);
          alert("Failed to load reviews. Please try again.");
        }
      }

      // Close reviews modal
      document
        .getElementById("close-reviews-modal")
        .addEventListener("click", () => {
          document.getElementById("restaurant-reviews-modal").classList.add("hidden");
        });

      // Close modal when clicking outside
      document
        .getElementById("restaurant-reviews-modal")
        .addEventListener("click", (e) => {
          if (e.target === e.currentTarget) {
            e.target.classList.add("hidden");
          }
        });
    </script>
  </body>
</html>
